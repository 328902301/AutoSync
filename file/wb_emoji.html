<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>表情预览</title>
	<meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
	<link rel="stylesheet" type="text/css"
		href="https://h5.sinaimg.cn/apps/vip/css/lib/marvel1.00.css?version=6a57a52c50fd79778583e3dcf383813122333">
	<link rel="stylesheet" type="text/css"
		href="https://h5.sinaimg.cn/apps/vip/css/emojishop/emojishop.css?version=6a57a52c50fd79778583e3dcf383813122333">
	<script type="text/javascript"
		src="https://h5.sinaimg.cn/apps/vip/js/lib/ios.js?version=6a57a52c50fd79778583e3dcf3838131223"></script>
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"></script>
</head>

<body>
	<div class="emojishop">
		<div class="card card22">
			<div class="card-wrap">
				<div class="card-main">
					<div class="m-img-box">
						<ul>
							<li><img
									src="http://vip.storage.weibo.com/gifimg_source/afbfd89e7e7a9b58d3839f0e8fc35257.png">
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<div class="emoji-intro">
			<div class="m-box emoji-intro__main">
				<div class="m-box-col emoji-name">龙小可第一弹<span class="link-type link-type__a">限免</span></div>
				<div class="emoji-ctrl">

					<!-- 1下载 2更新 0已下载 -->
					<button class="m-btn m-btn-download m-btn-down" data-type="1" data-version="1"
						data-downurl="https://new.vip.weibo.cn/Linktodown?usid=000p3uIbjx07mhl96aej090f01003o0T0k01"
						data-pkgid="116" id="pkg_down_116" style="display:none;">
						<span><em>下载</em></span>
						<em>下载</em>
					</button>
					<button class="m-btn m-btn-download xiuxiu" data-type="1" data-version="1"
						data-downurl="https://new.vip.weibo.cn/Linktodown?usid=000p3uIbjx07mhl96aej090f01003o0T0k01"
						data-pkgid="116" id="pkg_have_116" style="display:none;">
						<span><em>秀一秀</em></span>
						<em>秀一秀</em>
					</button>

					<button class="m-btn m-btn-download m-btn-down" data-type="1" data-version="1"
						data-downurl="https://new.vip.weibo.cn/Linktodown?usid=000p3uIbjx07mhl96aej090f01003o0T0k01"
						data-pkgid="116" id="pkg_update_116" style="display:none;">
						<span><em>更新</em></span>
						<em>更新</em>
					</button>
				</div>
			</div>
			<div class="emoji-des" id="gifimg_desc">

				我是一条小绿龙，我有好多的小秘密~
			</div>
			<div class="emoji-des" id="gifimg_desc_long">
				我是一条小绿龙，我有好多的小秘密~
			</div>
			<fieldset class="div-line">
				<legend>长按图片可预览</legend>
			</fieldset>
			<div class="emoji-list m-col-4">
				<div class="m-auto-list" id="emojibox">
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7q36u3g30740740u4.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/5c053ad5dbf92159d3d178e28d1157ed.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7pz9qlg3074074ab0.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/5079026804f926e8b76ee0127ec79433.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7prx26g3074074jsy.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/1c8415a6c2b21c4289700cd7d2292229.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7pobq4g3074074dgj.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/40417ee6fba3790faa55319d6374a41d.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7pkuntg30740740td.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/b4cf7be811b0125fbc94ae976428b52b.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7pc5mdg3074074q3f.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/9c7ffb76c2064f4b5778e364508ab50b.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7p4qveg3074074abf.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/ad653d8cd3e292e01de9fd9bfbe54fb4.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7p0y2ig3074074gna.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/867bd22c02ff1b1fe9e5db7c4c2c6c4a.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7oxevug3074074mxt.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/9a1279b0af35a0028582057ee804808e.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7orms4g3074074q46.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/6df8550f4f5e73d8d41834569157a430.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7okfehg3074074t9s.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/fdccea35c7d06f26c25bdbfa4820e79a.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7ofcmsg3074074aar.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/84a00cfdd1897707b7ed83e8092e21a5.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7oah8tg3074074jtd.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/4c3bb0178a3e3253e20ac3dc8c433869.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7o4u88g3074074ta8.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/48fe3eb625113d54d629e37f999ce457.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7o17beg3074074t9u.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/d1c3efe1c046ee71a63187e3efc6a8f9.png" />
						</div>
					</div>
					<div class="m-auto-box" node-type="emoji"
						data-src="http://ww4.sinaimg.cn/mw690/005EGbicly1ftcu7nwgddg30740743zm.gif">
						<div class="emoji-box">
							<img
								src="http://vip.storage.weibo.com/gifimg_source/ca624e2e1e155fb9d207b02427ee644b.png" />
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>














	<div class="card m-panel card6">
		<div class="card-wrap">
			<div class="card-main">
				<a href="https://new.vip.weibo.cn/vipcenter?portrait_only=1&topnavstyle=1&immersiveScroll=100&F=vipcenter_out"
					class="color-gray">进入用户中心 <i class="m-font m-font-arrow-right"></i></a>
			</div>
		</div>
	</div>
	</div>


	<div class="m-popup" id="share_success" style="display:none;">
		<div class="m-box m-box-dir m-box-center">
			<header>
				<i class="m-font m-font-line-check"></i>
			</header>
			<h3>分享成功</h3>
		</div>
	</div>
	<div class="m-popup" style="display:none;" id="share_error">
		<div class="m-box m-box-dir m-box-center">
			<header>
				<i class="m-font m-font-line-close"></i>
			</header>
			<h3>分享失败</h3>
		</div>
	</div>
	<input type="hidden" value="2a3bx001asdf2131232222" id="down_check" />
	<input type="hidden"
		value="sinaweibo://wbox?id=5cc40d2fb5fbd&return_url=https%3A%2F%2Fnew.vip.weibo.cn%2Fgifimg%2Fmall%3Fcallback%3D1&F=tq_pldt_dtsc"
		id="pay_url" />
	<input type="hidden" value="" id="F_value" />
	<input type="hidden" value="40000104" id="uicode" />

	<input type="hidden" value="" id="task_id">

	<script src="https://h5.sinaimg.cn/apps/vip/js/zepto1.2.0.js?version=6a57a52c50fd79778583e3dcf3838131"></script>

	<script>
		var res_down;
		var query_pkg_json = [];
		query_pkg_json = [{ "pkg_id": "116", "version": "1" }];
		$("#gifimg_desc_long").hide();
		$('#open_desc_lang').on('tap', function () {
			$("#gifimg_desc").hide();
			$("#gifimg_desc_long").show();
		});
		//通知下载
		function noticeDownload(me, version, down_url, pkg_id) {
			console.log(111);
			down_check = $("#down_check").val();
			// do something
			WeiboJSBridge.invoke("vipEmotionManager", { "downloadparam": { "pkg_id": pkg_id, "version": version, "check": down_check, "url": down_url } }, function (params, success, code) {
				if (success) {
					var status = params.downloadresult.result;
					if (status == 1) {
						me.removeClass('m-btn-download__active').addClass('m-btn-download__done');
						me.removeClass('m-btn-download__done').addClass('m-btn-download__disable').attr({ 'disabled': 'disabled', 'data-type': '0' });
						me.html('已下载');
						taskNoticeReq(pkg_id);
					} else {
						download_fail_notice(pkg_id, version, down_url, status, code);
					}

					return true;
				} else {
					download_fail_notice(pkg_id, version, down_url, '', code);
					return false;
					if (code == WeiboJSBridge.STATUS_CODE.NO_RESULT) {
					}
				}
			});
		}
		if (window.WeiboJSBridge) {
			queryDownloadStatus();
		} else {
			document.addEventListener('WeiboJSBridgeReady', function () {
				queryDownloadStatus();
			});
		}

		//查询下载状态
		function queryDownloadStatus() {
			console.log(222);
			// do something
			WeiboJSBridge.invoke("vipEmotionManager", { "queryparam": query_pkg_json }, function (params, success, code) {

				//var dataObj=eval(params);//转换为json对象   
				if (success) {
					$.each(params.querylist, function (key, value) {
						if (value == 0) {  //0已下载状态  2是更新  3是未下载
							$("#pkg_have_" + key).show();
							taskNoticeReq(key);
						} else if (value == 2) {
							$("#pkg_update_" + key).show();
						} else {
							$("#pkg_down_" + key).show();
						}
					});
					//var last=params.toJSONString();
					//var last=params.toJSONString();
					//alert(last);
					//alert(params.querylist);
					//alert('<h2>当前位置信息：（' + params + '）</h2>');
				} else {
					if (code == WeiboJSBridge.STATUS_CODE.NO_RESULT) {
						// do something.
					}
				}
			});
		}

		function taskNoticeReq(pkg_id) {
			console.log(333);
			var task_id = parseInt(document.getElementById('task_id').value);
			if (task_id > 0) {
				$.ajax({
					"url": "/gifimg/detail?task_req=1",
					"dataType": "json",
					'data': { 'pkg_id': pkg_id, 'task_id': task_id },
					success: function (data) {

					}
				});
			}
		}

		function download() {
			console.log(444);
			$('.m-btn-down').on('tap', function () {
				var me = $(this);
				var state = me.attr('data-type');   //1是可下载2不可下载需会员
				var version = me.attr('data-version');
				var down_url = me.attr('data-downurl');
				var pkg_id = me.attr('data-pkgid');
				pay_url = $("#pay_url").val();

				if (state == 1) {
					me.addClass('m-btn-download__active');
					if (window.WeiboJSBridge) {
						noticeDownload(me, version, down_url, pkg_id);
					} else {
						document.addEventListener('WeiboJSBridgeReady', function () {
							noticeDownload(me, version, down_url, pkg_id);
						});
					}

				} else if (state == 2) {
					popup({
						title: "这是会员专属表情，立刻续费会员下载该表情吗？",
						btn1: "以后再说",
						btn2: "续费会员",
						url: pay_url,
					});
				} else {
					return;
				};
			});
		};
		download();
		$('.xiuxiu').on('tap', function () {
			console.log(555);
			var me = $(this);
			var pkg_id = me.attr('data-pkgid');
			$.ajax({
				"url": "/aj/gifimg/share?pkg_id=" + pkg_id,
				"dataType": "json",
				success: function (data) {
					if (data.code == 100000) {
						$("#share_success").css('display', 'block');
						setTimeout("$('#share_success').css('display','none')", 1000);
					} else {
						$("#share_error").css('display', 'block');
						setTimeout("$('#share_error').css('display','none')", 1000);
					}
				}
			});
		});
		function popup(obj) {
			console.log(666);
			create_accesslog()
			var obj;
			var mask = '<div class="m-mask" node-type="mask"></div>';
			var dom = '<div class="m-alert" node-type="alert"><header><h2>' + obj.title + '</h2></header><footer class="m-box"><div class="m-box-col"><a href="javascript:;" node-type="close">' + obj.btn1 + '</a></div><div class="m-box-col"><a href="' + obj.url + '">' + obj.btn2 + '</a></div></footer></div>';
			$('body').append(mask, dom);
			$('.m-alert').css('pointer-events', 'none');
			setTimeout(function () {
				$('.m-alert').css('pointer-events', 'auto');
			}, 400);
			$('html').css({ 'overflow': 'hidden', 'height': '100%' });
			$('body').css({ 'overflow': 'hidden', 'height': '100%' });
			function preventDefault(ev) {
				ev.preventDefault()
			};
			$(document).bind('touchmove', preventDefault, false);
			function close() {
				$('[node-type=close]').on('tap', function () {
					$('[node-type=mask]').remove();
					$('[node-type=alert]').remove();
					$('html').removeAttr("style");
					$('body').removeAttr("style");
					$(document).unbind('touchmove', preventDefault, false)
				})
			}
			close();
		}


		function view(col) {
			console.log(777);
			var canvas = document.getElementById('emojibox');
			var m = canvas.children.length;

			var w = canvas.offsetWidth;
			var h = canvas.offsetHeight;
			var square = w / col;
			var fingerdown = false;
			var fingermove = false;
			var curIndex = null;
			var long = false;
			var timeout;
			function getFingerMove(canvas, evt) {
				var rect = canvas.getBoundingClientRect();
				return {
					x: evt.clientX - rect.left,
					y: evt.clientY - rect.top
				}
			}
			function getIndex(e) {
				var pos = getFingerMove(canvas, e);
				var posx = pos.x < 0 ? 0 : pos.x > w ? w - 1 : pos.x;
				var posy = pos.y < 0 ? 0 : pos.y > h ? h - 1 : pos.y;
				var i = parseInt(posx / square);
				var j = parseInt(posy / square);
				var n = i + 1 + j * col;
				return n;
			}
			function preloadImages(array) {
				console.log(111, array);
				if (!preloadImages.list) {
					preloadImages.list = [];
				}
				var list = preloadImages.list;
				for (var i = 0; i < array.length; i++) {
					var img = new Image();
					img.onload = function () {
						var index = list.indexOf(this);
						if (index !== -1) {
							list.splice(index, 1);
						}
					}
					list.push(img);
					img.src = array[i];
				}
			}
			function allImgs() {
				var doms = $('[node-type=emoji]');
				var list = [];

				for (var i = 0; i < doms.length; i++) {
					var dom = doms.eq(i);
					var img = dom.attr('data-src');
					list.push(img);
				}

				return list;
			}
			function showEmoji(n) {
				var doms = $('[node-type=emoji]');
				var me = doms.eq(n - 1);
				var imgsrc = me.attr('data-src');
				var viewbox = '<div class="emoji-show" node-type="view-box" id="viewing"><img src="' + imgsrc + '"></div>';
				me.append(viewbox);
				me.addClass('m-cur');
			}
			function eventDown(e) {
				fingerdown = true;
				e = e.targetTouches[0];
				var n = getIndex(e);
				var imgs = allImgs();
				preloadImages(imgs);
				curIndex = n;
				timeout = setTimeout(function () {
					if (fingerdown && !fingermove) {
						long = true;
						showEmoji(n);
					}
				}, 500);
			}
			function eventUp(e) {

				clearTimeout(timeout);
				fingerdown = false;
				fingermove = false;
				long = false;
				if ($('#viewing').length > 0) {
					$('#viewing').parent().removeClass('m-cur');
					$('#viewing').remove();
				}
				return true;
			}
			function eventMove(e) {
				fingermove = true;
				if (!long) {
					return;
				}
				e.preventDefault();
				if (e.changedTouches) {
					e = e.changedTouches[e.changedTouches.length - 1];
				}
				var n = getIndex(e);
				if (n > m) {
					return;
				}
				if (curIndex != n) {
					if ($('#viewing').length > 0) {
						$('#viewing').parent().removeClass('m-cur');
						$('#viewing').remove();
					}
					showEmoji(n);
				}
				curIndex = n;
			}
			canvas.addEventListener('touchstart', eventDown);
			canvas.addEventListener('touchend', eventUp);
			canvas.addEventListener('touchmove', eventMove);
		}
		view(4);
		function create_accesslog() {
			var F_value = "dongtuyulan";
			$.ajax({
				'type': "GET",
				'url': "/aj/accesslog/privilege",
				"data": { F: F_value, source: 3 },
				beforeSend: function () { },
				success: function (d) { }
			});
		}
		function download_fail_notice(pkg_id, version, down_url, status, code) {
			var post_data = {
				'type': 'gifimg',
				'pkg_id': pkg_id,
				'version': version,
				'down_url': down_url,
				'status': status,
				'code': code
			};
			var url = 'https://new.vip.weibo.cn/aj/reported';
			$.ajax({
				'url': url,
				'type': 'post',
				'data': post_data,
				'dataType': 'json',
				'async': false,
				'success': function (res) { },
				'error': function (jqXHR, textStatus, errorThrown) { }
			});
		}
	</script>
</body>

</html>