const scriptName="BiliBili",storyAidKey="bilibili_story_aid",blackKey="bilibili_feed_black";let magicJS=MagicJS("BiliBili","INFO"),blacklist=[];if(magicJS.read(blackKey))blacklist=magicJS.read(blackKey).split(";");else{const e="";magicJS.write(blackKey,e),blacklist=e.split(";")}function MagicJS(e="MagicJS",t="INFO"){return new class{constructor(){if(this.version="2.2.3.3",this.scriptName=e,this.logLevels={DEBUG:5,INFO:4,NOTIFY:3,WARNING:2,ERROR:1,CRITICAL:0,NONE:-1},this.isLoon="undefined"!=typeof $loon,this.isQuanX="undefined"!=typeof $task,this.isJSBox="undefined"!=typeof $drive,this.isNode="undefined"!=typeof module&&!this.isJSBox,this.isSurge="undefined"!=typeof $httpClient&&!this.isLoon,this.node={request:void 0,fs:void 0,data:{}},this.iOSUserAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 13_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Mobile/15E148 Safari/604.1",this.pcUserAgent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.125 Safari/537.36 Edg/84.0.522.59",this.logLevel=t,this._barkUrl="",this.isNode){this.node.fs=require("fs"),this.node.request=require("request");try{this.node.fs.accessSync("./magic.json",this.node.fs.constants.R_OK|this.node.fs.constants.W_OK)}catch(e){this.node.fs.writeFileSync("./magic.json","{}",{encoding:"utf8"})}this.node.data=require("./magic.json")}else this.isJSBox&&($file.exists("drive://MagicJS")||$file.mkdir("drive://MagicJS"),$file.exists("drive://MagicJS/magic.json")||$file.write({data:$data({string:"{}"}),path:"drive://MagicJS/magic.json"}))}set barkUrl(e){this._barkUrl=e.replace(/\/+$/g,"")}set logLevel(e){this._logLevel="string"==typeof e?e.toUpperCase():"DEBUG"}get logLevel(){return this._logLevel}get isRequest(){return"undefined"!=typeof $request&&"undefined"==typeof $response}get isResponse(){return"undefined"!=typeof $response}get request(){return"undefined"!=typeof $request?$request:void 0}get response(){return"undefined"!=typeof $response?($response.hasOwnProperty("status")&&($response.statusCode=$response.status),$response.hasOwnProperty("statusCode")&&($response.status=$response.statusCode),$response):void 0}get platform(){return this.isSurge?"Surge":this.isQuanX?"Quantumult X":this.isLoon?"Loon":this.isJSBox?"JSBox":this.isNode?"Node.js":"Unknown"}read(e,t=""){let i="";this.isSurge||this.isLoon?i=$persistentStore.read(e):this.isQuanX?i=$prefs.valueForKey(e):this.isNode?i=this.node.data:this.isJSBox&&(i=$file.read("drive://MagicJS/magic.json").string);try{this.isNode&&(i=i[e]),this.isJSBox&&(i=JSON.parse(i)[e]),t&&("string"==typeof i&&(i=JSON.parse(i)),i=i&&"object"==typeof i?i[t]:null)}catch(s){this.logError(s),i=t?{}:null,this.del(e)}void 0===i&&(i=null);try{i&&"string"==typeof i&&(i=JSON.parse(i))}catch(e){}return this.logDebug(`READ DATA [${e}]${t?`[${t}]`:""}(${typeof i})\n${JSON.stringify(i)}`),i}write(e,t,i=""){let s=i?{}:"";if(i&&(this.isSurge||this.isLoon)?s=$persistentStore.read(e):i&&this.isQuanX?s=$prefs.valueForKey(e):this.isNode?s=this.node.data:this.isJSBox&&(s=JSON.parse($file.read("drive://MagicJS/magic.json").string)),i){try{"string"==typeof s&&(s=JSON.parse(s)),s="object"==typeof s&&s?s:{}}catch(t){this.logError(t),this.del(e),s={}}this.isJSBox||this.isNode?(s[e]&&"object"==typeof s[e]||(s[e]={}),s[e].hasOwnProperty(i)||(s[e][i]=null),void 0===t?delete s[e][i]:s[e][i]=t):void 0===t?delete s[i]:s[i]=t}else this.isNode||this.isJSBox?void 0===t?delete s[e]:s[e]=t:s=void 0===t?null:t;"object"==typeof s&&(s=JSON.stringify(s)),this.isSurge||this.isLoon?$persistentStore.write(s,e):this.isQuanX?$prefs.setValueForKey(s,e):this.isNode?this.node.fs.writeFileSync("./magic.json",s):this.isJSBox&&$file.write({data:$data({string:s}),path:"drive://MagicJS/magic.json"}),this.logDebug(`WRITE DATA [${e}]${i?`[${i}]`:""}(${typeof t})\n${JSON.stringify(t)}`)}del(e,t=""){this.logDebug(`DELETE KEY [${e}]${t?`[${t}]`:""}`),this.write(e,null,t)}notify(e=this.scriptName,t="",i="",s=""){if(s=(e=>{let t={};if("string"==typeof e)this.isLoon?t={openUrl:e}:this.isQuanX?t={"open-url":e}:this.isSurge&&(t={url:e});else if("object"==typeof e)if(this.isLoon)t.openUrl=e["open-url"]?e["open-url"]:"",t.mediaUrl=e["media-url"]?e["media-url"]:"";else if(this.isQuanX)t=e["open-url"]||e["media-url"]?e:{};else if(this.isSurge){let i=e["open-url"]||e.openUrl;t=i?{url:i}:{}}return t})(s),1==arguments.length&&(e=this.scriptName,t="",i=arguments[0]),this.logNotify(`title:${e}\nsubTitle:${t}\nbody:${i}\noptions:${"object"==typeof s?JSON.stringify(s):s}`),this.isSurge)$notification.post(e,t,i,s);else if(this.isLoon)s?$notification.post(e,t,i,s):$notification.post(e,t,i);else if(this.isQuanX)$notify(e,t,i,s);else if(this.isNode){if(this._barkUrl){let s=encodeURI(`${e}/${t}\n${i}`);this.get(`${this._barkUrl}/${s}`,(()=>{}))}}else if(this.isJSBox){let s={title:e,body:t?`${t}\n${i}`:i};$push.schedule(s)}}notifyDebug(e=this.scriptName,t="",i="",s=""){"DEBUG"===this.logLevel&&(1==arguments.length&&(e=this.scriptName,t="",i=arguments[0]),this.notify(e,t,i,s))}log(e,t="INFO"){this.logLevels[this._logLevel]<this.logLevels[t.toUpperCase()]||console.log(`[${t}] [${this.scriptName}]\n${e}\n`)}logDebug(e){this.log(e,"DEBUG")}logInfo(e){this.log(e,"INFO")}logNotify(e){this.log(e,"NOTIFY")}logWarning(e){this.log(e,"WARNING")}logError(e){this.log(e,"ERROR")}logRetry(e){this.log(e,"RETRY")}adapterHttpOptions(e,t){let i="object"==typeof e?Object.assign({},e):{url:e,headers:{}};i.hasOwnProperty("header")&&!i.hasOwnProperty("headers")&&(i.headers=i.header,delete i.header);const s={accept:"Accept","accept-ch":"Accept-CH","accept-charset":"Accept-Charset","accept-features":"Accept-Features","accept-encoding":"Accept-Encoding","accept-language":"Accept-Language","accept-ranges":"Accept-Ranges","access-control-allow-credentials":"Access-Control-Allow-Credentials","access-control-allow-origin":"Access-Control-Allow-Origin","access-control-allow-methods":"Access-Control-Allow-Methods","access-control-allow-headers":"Access-Control-Allow-Headers","access-control-max-age":"Access-Control-Max-Age","access-control-expose-headers":"Access-Control-Expose-Headers","access-control-request-method":"Access-Control-Request-Method","access-control-request-headers":"Access-Control-Request-Headers",age:"Age",allow:"Allow",alternates:"Alternates",authorization:"Authorization","cache-control":"Cache-Control",connection:"Connection","content-encoding":"Content-Encoding","content-language":"Content-Language","content-length":"Content-Length","content-location":"Content-Location","content-md5":"Content-MD5","content-range":"Content-Range","content-security-policy":"Content-Security-Policy","content-type":"Content-Type",cookie:"Cookie",dnt:"DNT",date:"Date",etag:"ETag",expect:"Expect",expires:"Expires",from:"From",host:"Host","if-match":"If-Match","if-modified-since":"If-Modified-Since","if-none-match":"If-None-Match","if-range":"If-Range","if-unmodified-since":"If-Unmodified-Since","last-event-id":"Last-Event-ID","last-modified":"Last-Modified",link:"Link",location:"Location","max-forwards":"Max-Forwards",negotiate:"Negotiate",origin:"Origin",pragma:"Pragma","proxy-authenticate":"Proxy-Authenticate","proxy-authorization":"Proxy-Authorization",range:"Range",referer:"Referer","retry-after":"Retry-After","sec-websocket-extensions":"Sec-Websocket-Extensions","sec-websocket-key":"Sec-Websocket-Key","sec-websocket-origin":"Sec-Websocket-Origin","sec-websocket-protocol":"Sec-Websocket-Protocol","sec-websocket-version":"Sec-Websocket-Version",server:"Server","set-cookie":"Set-Cookie","set-cookie2":"Set-Cookie2","strict-transport-security":"Strict-Transport-Security",tcn:"TCN",te:"TE",trailer:"Trailer","transfer-encoding":"Transfer-Encoding",upgrade:"Upgrade","user-agent":"User-Agent","variant-vary":"Variant-Vary",vary:"Vary",via:"Via",warning:"Warning","www-authenticate":"WWW-Authenticate","x-content-duration":"X-Content-Duration","x-content-security-policy":"X-Content-Security-Policy","x-dnsprefetch-control":"X-DNSPrefetch-Control","x-frame-options":"X-Frame-Options","x-requested-with":"X-Requested-With","x-surge-skip-scripting":"X-Surge-Skip-Scripting"};if("object"==typeof i.headers)for(let e in i.headers)s[e]&&(i.headers[s[e]]=i.headers[e],delete i.headers[e]);i.headers&&"object"==typeof i.headers&&i.headers["User-Agent"]||(i.headers&&"object"==typeof i.headers||(i.headers={}),this.isNode?i.headers["User-Agent"]=this.pcUserAgent:i.headers["User-Agent"]=this.iOSUserAgent);let o=!1;if(("object"==typeof i.opts&&(!0===i.opts.hints||!0===i.opts["Skip-Scripting"])||"object"==typeof i.headers&&!0===i.headers["X-Surge-Skip-Scripting"])&&(o=!0),o||(this.isSurge?i.headers["X-Surge-Skip-Scripting"]=!1:this.isLoon?i.headers["X-Requested-With"]="XMLHttpRequest":this.isQuanX&&("object"!=typeof i.opts&&(i.opts={}),i.opts.hints=!1)),this.isSurge&&!o||delete i.headers["X-Surge-Skip-Scripting"],!this.isQuanX&&i.hasOwnProperty("opts")&&delete i.opts,this.isQuanX&&i.hasOwnProperty("opts")&&delete i.opts["Skip-Scripting"],"GET"===t&&!this.isNode&&i.body){let e=Object.keys(i.body).map((e=>void 0===i.body?"":`${encodeURIComponent(e)}=${encodeURIComponent(i.body[e])}`)).join("&");i.url.indexOf("?")<0&&(i.url+="?"),i.url.lastIndexOf("&")+1!=i.url.length&&i.url.lastIndexOf("?")+1!=i.url.length&&(i.url+="&"),i.url+=e,delete i.body}return this.isQuanX?(i.hasOwnProperty("body")&&"string"!=typeof i.body&&(i.body=JSON.stringify(i.body)),i.method=t):this.isNode?(delete i.headers["Accept-Encoding"],"object"==typeof i.body&&("GET"===t?(i.qs=i.body,delete i.body):"POST"===t&&(i.json=!0,i.body=i.body))):this.isJSBox&&(i.header=i.headers,delete i.headers),i}adapterHttpResponse(e){let t={body:e.body,headers:e.headers,json:()=>JSON.parse(t.body)};return e.hasOwnProperty("statusCode")&&e.statusCode&&(t.status=e.statusCode),t}get(e,t){let i=this.adapterHttpOptions(e,"GET");this.logDebug(`HTTP GET: ${JSON.stringify(i)}`),this.isSurge||this.isLoon?$httpClient.get(i,t):this.isQuanX?$task.fetch(i).then((e=>{e.status=e.statusCode,t(null,e,e.body)}),(e=>t(e.error,null,null))):this.isNode?this.node.request.get(i,((e,i,s)=>{i=this.adapterHttpResponse(i),t(e,i,s)})):this.isJSBox&&(i.handler=e=>{let i=e.error?JSON.stringify(e.error):void 0,s="object"==typeof e.data?JSON.stringify(e.data):e.data;t(i,e.response,s)},$http.get(i))}getPromise(e){return new Promise(((t,i)=>{magicJS.get(e,((e,s)=>{e?i(e):t(s)}))}))}post(e,t){let i=this.adapterHttpOptions(e,"POST");if(this.logDebug(`HTTP POST: ${JSON.stringify(i)}`),this.isSurge||this.isLoon)$httpClient.post(i,t);else if(this.isQuanX)$task.fetch(i).then((e=>{e.status=e.statusCode,t(null,e,e.body)}),(e=>{t(e.error,null,null)}));else if(this.isNode){let e=this.node.request.post(i,t);e.status=e.statusCode,delete e.statusCode}else this.isJSBox&&(i.handler=e=>{let i=e.error?JSON.stringify(e.error):void 0,s="object"==typeof e.data?JSON.stringify(e.data):e.data;t(i,e.response,s)},$http.post(i))}get http(){return{get:this.getPromise,post:this.post}}done(e={}){"undefined"!=typeof $done&&$done(e)}isToday(e){if(null==e)return!1;{let t=new Date;return"string"==typeof e&&(e=new Date(e)),t.getFullYear()==e.getFullYear()&&t.getMonth()==e.getMonth()&&t.getDay()==e.getDay()}}isNumber(e){return"NaN"!==parseFloat(e).toString()}attempt(e,t=null){return e.then((e=>[null,e])).catch((e=>(this.logError(e),[e,t])))}retry(e,t=5,i=0,s=null){return(...o)=>new Promise(((r,a)=>{(function o(...n){Promise.resolve().then((()=>e.apply(this,n))).then((e=>{"function"==typeof s?Promise.resolve().then((()=>s(e))).then((()=>{r(e)})).catch((e=>{t>=1?i>0?setTimeout((()=>o.apply(this,n)),i):o.apply(this,n):a(e),t--})):r(e)})).catch((e=>{this.logRetry(e),t>=1&&i>0?setTimeout((()=>o.apply(this,n)),i):t>=1?o.apply(this,n):a(e),t--}))}).apply(this,o)}))}formatTime(e,t="yyyy-MM-dd hh:mm:ss"){var i={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in i)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[e]:("00"+i[e]).substr((""+i[e]).length)));return t}now(){return this.formatTime(new Date,"yyyy-MM-dd hh:mm:ss")}today(){return this.formatTime(new Date,"yyyy-MM-dd")}sleep(e){return new Promise((t=>setTimeout(t,e)))}}(e)}(()=>{let e=null;if(magicJS.isResponse)switch(!0){case/^https:\/\/app\.bilibili\.com\/x\/v2\/splash\/list/.test(magicJS.request.url):try{let t=JSON.parse(magicJS.response.body);if(t.data&&t.data.list)for(let e of t.data.list)e.duration=0,e.begin_time=2240150400,e.end_time=2240150400;e=JSON.stringify(t)}catch(e){magicJS.logError(`开屏广告（预加载）出现异常：${e}`)}break;case/^https:\/\/app\.bilibili\.com\/x\/v2\/feed\/index\?/.test(magicJS.request.url):try{let t=JSON.parse(magicJS.response.body),i=[];for(let e of t.data.items)e.hasOwnProperty("banner_item")||e.hasOwnProperty("ad_info")||blacklist.includes(e.args.up_name)||-1!==e.card_goto.indexOf("ad")||"small_cover_v2"!==e.card_type&&"large_cover_v1"!==e.card_type&&"large_cover_single_v9"!==e.card_type||i.push(e);t.data.items=i,e=JSON.stringify(t)}catch(e){magicJS.logError(`推荐去广告出现异常：${e}`)}break;case/^https?:\/\/app\.bilibili\.com\/x\/v2\/feed\/index\/story\?/.test(magicJS.request.url):try{let t=JSON.parse(magicJS.response.body),i=[];for(let e of t.data.items)e.hasOwnProperty("ad_info")||-1!==e.card_goto.indexOf("ad")||i.push(e);t.data.items=i,e=JSON.stringify(t)}catch(e){magicJS.logError(`记录Story的aid出现异常：${e}`)}break;case/^https?:\/\/app\.bilibili\.com\/x\/resource\/show\/tab/.test(magicJS.request.url):try{const t=new Set([39,40,41,774,857,545,151,442,99,100,101,554,556]),i=new Set([176,107]),s=new Set([177,178,179,181,102,104,106,486,488,489]);let o=JSON.parse(magicJS.response.body);if(o.data.tab){let e=o.data.tab.filter((e=>t.has(e.id)));o.data.tab=e}let r=magicJS.read(storyAidKey);if(r||(r="246834163"),o.data.top){let e=o.data.top.filter((e=>(222!==e.id&&107!==e.id||(e.uri=`bilibili://story/${r}`,e.icon="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/script/bilibili/bilibili_icon.png",e.tab_id="Story_Top",e.name="Story"),i.has(e.id))));o.data.top=e}if(o.data.bottom){let e=o.data.bottom.filter((e=>s.has(e.id)));o.data.bottom=e}e=JSON.stringify(o)}catch(e){magicJS.logError(`标签页处理出现异常：${e}`)}break;case/^https?:\/\/app\.bilibili\.com\/x\/v2\/account\/mine/.test(magicJS.request.url):try{let t=JSON.parse(magicJS.response.body);const i=new Set([396,397,398,399,402,404,407,410,425,426,427,428,430,432,433,434,494,495,496,497,500,501]);t.data.sections_v2.forEach(((e,s)=>{e.items.forEach((e=>{622===e.id&&(e.title="会员购",e.uri="bilibili://mall/home")}));let o=e.items.filter((e=>i.has(e.id)));t.data.sections_v2[s].button={},t.data.sections_v2[s].be_up_title=void 0,t.data.sections_v2[s].tip_icon=void 0,t.data.sections_v2[s].tip_title=void 0;for(let e=0;e<t.data.sections_v2.length;e++)"创作中心"!=t.data.sections_v2[e].title&&"創作中心"!=t.data.sections_v2[e].title||(t.data.sections_v2[e].title=void 0,t.data.sections_v2[e].type=void 0);t.data.vip_section_v2=void 0,t.data.vip_section=void 0,t.data.sections_v2[s].items=o,t.data.hasOwnProperty("live_tip")&&(t.data.live_tip={}),t.data.hasOwnProperty("answer")&&(t.data.answer={}),t.data.vip_type=2,t.data.vip.type=2,t.data.vip.status=1,t.data.vip.vip_pay_type=1,t.data.vip.due_date=4669824160})),e=JSON.stringify(t)}catch(e){magicJS.logError(`我的页面处理出现异常：${e}`)}break;case/^https?:\/\/app\.bilibili\.com\/x\/v2\/account\/myinfo\?/.test(magicJS.request.url):try{let t=JSON.parse(magicJS.response.body);t.data.vip.type=2,t.data.vip.status=1,t.data.vip.vip_pay_type=1,t.data.vip.due_date=4669824160,e=JSON.stringify(t)}catch(e){magicJS.logError(`1080P出现异常：${e}`)}break;case/^https?:\/\/app\.bilibili\.com\/x\/v2\/search\/square/.test(magicJS.request.url):try{let t=JSON.parse(magicJS.response.body);t.data={type:"history",title:"搜索历史",search_hotword_revision:2},e=JSON.stringify(t)}catch(e){magicJS.logError(`热搜去广告出现异常：${e}`)}break;case/^https?:\/\/api\.live\.bilibili\.com\/xlive\/app-room\/v1\/index\/getInfoByRoom/.test(magicJS.request.url):try{let t=JSON.parse(magicJS.response.body);t.data.activity_banner_info=null,e=JSON.stringify(t)}catch(e){magicJS.logError(`直播去广告出现异常：${e}`)}break;case/pgc\/page\/bangumi/.test(magicJS.request.url):try{let t=JSON.parse(magicJS.response.body);t.result.modules.forEach((e=>{e.style.startsWith("banner")&&(e.items=e.items.filter((e=>!(-1==e.link.indexOf("play"))))),e.style.startsWith("function")&&(e.items=e.items.filter((e=>-1==e.blink.indexOf("www.bilibili.com")))),e.style.startsWith("tip")&&(e.items=[])})),e=JSON.stringify(t)}catch(e){magicJS.logError(`追番去广告出现异常：${e}`)}break;case/pgc\/page\/cinema\/tab\?/.test(magicJS.request.url):try{let t=JSON.parse(magicJS.response.body);t.result.modules.forEach((e=>{e.style.startsWith("banner")&&(e.items=e.items.filter((e=>!(-1==e.link.indexOf("play"))))),e.style.startsWith("function")&&(e.items=e.items.filter((e=>-1==e.blink.indexOf("www.bilibili.com")))),e.style.startsWith("tip")&&(e.items=[])})),e=JSON.stringify(t)}catch(e){magicJS.logError(`观影页去广告出现异常：${e}`)}break;default:magicJS.logWarning("触发意外的请求处理，请确认脚本或复写配置正常。")}else magicJS.logWarning("触发意外的请求处理，请确认脚本或复写配置正常。");e?magicJS.done({body:e}):magicJS.done()})();