let $=nobyda(),run=EnvInfo();function EnvInfo(){const e=$request.url;if("undefined"!=typeof $response){const t=JSON.parse($response.body||"{}"),n=t.data||t.result||{},i=[n.title,n.series&&n.series.series_title,n.season_title].filter((e=>/\u5340\uff09/.test(e)))[0]||n.title,o=-404===t.code?-404:null;SwitchRegion(i||o).then((t=>t?$done({status:$.isQuanX?"HTTP/1.1 307":307,headers:{Location:e},body:"{}"}):$done({body:JSON.stringify(body)})))}else{const t={url:e.replace(/%20(%E6%B8%AF|%E5%8F%B0|%E4%B8%AD)&/g,"&")};SwitchRegion(e).then((()=>$done(t)))}}async function SwitchRegion(e){const t=$.read("BiliArea_Policy")||"Bilibili",n=$.read("BiliArea_CN")||"DIRECT",i=$.read("BiliArea_TW")||"台湾节点",o=$.read("BiliArea_HK")||"香港节点",s=$.read("BiliArea_DF")||"FALLBACK",r=$.read("BiliArea_disabled")||"",u=await $.getPolicy(t),a=(()=>{let t;if(/\u6e2f[\u4e00-\u9fa5]+\u5340|%20%E6%B8%AF&/.test(e)){const n=/\u53f0[\u4e00-\u9fa5]+\u5340/.test(e);u==o||u==i&&n||(t=o)}else/\u53f0[\u4e00-\u9fa5]+\u5340|%20%E5%8F%B0&/.test(e)?u!=i&&(t=i):-404===e?u!=s&&(t=s):u!=n&&(t=n);return $.isQuanX&&"direct"===u&&"DIRECT"===t&&(t=null),t})();if(a&&!r.includes($.ssid||void 0)){const n=await $.setPolicy(t,a),i="true"===$.read("BiliAreaNotify"),o=SwitchStatus(n,u,a);if(i?console.log(`${/^(http|-404)/.test(e)||!e?"":e}\n${o}`):$.notify(/^(http|-404)/.test(e)||!e?"":e,"",o),n)return!0}return!1}function SwitchStatus(e,t,n){return e&&"number"!=typeof t?`${t}  =>  ${n}  =>  🟢`:2===t?"切换失败, 策略组名未填写或填写有误 ⚠️":3===t?"切换失败, 不支持您的VPN应用版本 ⚠️":0===e?"切换失败, 子策略名未填写或填写有误 ⚠️":"策略切换失败, 未知错误 ⚠️"}function nobyda(){const e="undefined"!=typeof $httpClient,t="undefined"!=typeof $task,n="undefined"!=typeof $network&&"undefined"!=typeof $script,i=t&&"undefined"!=typeof $environment?$environment.ssid:n&&$network.wifi?$network.wifi.ssid:void 0,o=e=>e?(e.status?e.statusCode=e.status:e.statusCode&&(e.status=e.statusCode),e):null;return{getPolicy:e=>n?"undefined"==typeof $httpAPI?3:new Promise((t=>{$httpAPI("GET","v1/policy_groups/select",{group_name:encodeURIComponent(e)},(e=>t(e.policy||2)))})):t?"undefined"==typeof $configuration?3:new Promise((t=>{$configuration.sendMessage({action:"get_policy_state"}).then((n=>{n.ret&&n.ret[e]?t(n.ret[e][1]):t(2)}),(()=>t()))})):void 0,setPolicy:(e,i)=>n&&"undefined"!=typeof $httpAPI?new Promise((t=>{$httpAPI("POST","v1/policy_groups/select",{group_name:e,policy:i},(e=>t(!e.error||0)))})):t&&"undefined"!=typeof $configuration?new Promise((t=>{$configuration.sendMessage({action:"set_policy_state",content:{[e]:i}}).then((e=>t(!e.error||0)),(()=>t()))})):void 0,isSurge:n,isQuanX:t,notify:(n,i,o)=>{console.log(`${n}\n${i}\n${o}`),t&&$notify(n,i,o),e&&$notification.post(n,i,o)},read:n=>t?$prefs.valueForKey(n):e?$persistentStore.read(n):void 0,ssid:i,get:(i,s)=>{t&&(i.method="GET",$task.fetch(i).then((e=>{s(null,o(e),e.body)}),(e=>s(e.error,null,null)))),e&&(n&&(i.headers["X-Surge-Skip-Scripting"]=!1),$httpClient.get(i,((e,t,n)=>{s(e,o(t),n)})))}}}