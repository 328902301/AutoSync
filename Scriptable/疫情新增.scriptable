{
  "always_run_in_app" : false,
  "icon" : {
    "color" : "blue",
    "glyph" : "feather-alt"
  },
  "name" : "「DJG」疫情新增",
  "script" : "\/*\n\/\/ 抖音搜索：大舅哥科技\n\/\/ 微信搜索小程序「大舅哥科技」\n\/\/ 获取更多精美实用 iOS 桌面组件！\n\/\/ 更多免费精选快捷指令、壁纸，等你！\n\/\/ ***************************\n\/\/ 环境框架   ：@ DmYY  \n\/\/ script \t ：原作者Pih 由DJG修改\n*\/\n\nFILE = FileManager.local()\nFILEPATH = FILE.joinPath(FILE.libraryDirectory(), \"\/DJG.js\")\nconst { DJG, Runing } = importModule(FILEPATH);\n\n\/\/ @组件代码开始\nclass Widget extends DJG {\n  constructor(arg) {\n    super(arg);\n    this.name = '疫情新增'\n    this.widget_ID = \"DJG-115\"\n    this.version = \"V3.5\";\n    this.covidUrl = \"https:\/\/api.inews.qq.com\/newsqa\/v1\/query\/inner\/publish\/modules\/list?modules=statisGradeCityDetail,diseaseh5Shelf\";\n    \/\/this.covidUrl = \"https:\/\/view.inews.qq.com\/g2\/getOnsInfo?name=disease_h5\";\n    this.city = [\n      '江苏','云南','广东','湖南','湖北','上海','四川','天津','河南','山东','福建','陕西','北京','黑龙江','浙江',\n      '河北','安徽','新疆','江西','重庆','吉林','辽宁','内蒙古','广西','山西','甘肃','海南','贵州','宁夏','青海'];\n\tthis.cityCode = [\n      'jiangsu','yn','gd','hn','hb','sh','cd','tj','henan','sd','fj','xian','bj','helongjiang','zj','hebei','ah',\n      'xinjiang','jiangxi','cq','jilin','ln','neimenggu','guangxi','shanxi','gansu','hainan','guizhou','ningxia','qinghai','xizang'];\n    this.Run(module.filename, args);\n  }\n  \n  \/**\n   * 渲染函数，函数名固定\n   * 可以根据 this.widgetFamily 来判断小组件尺寸，以返回不同大小的内容\n   *\/\n  async render () {\n    let widget = this.getWidget();\n    await this.getWidgetBackgroundImage(widget);\n    try{\n      await this.covidData();\n      switch (this.widgetFamily) {\n        case 'small':\n        \tawait this.renderSmall(widget);\n        \tbreak;\n        case 'medium':\n        \tawait this.renderMedium(widget);\n        \tbreak;\n        default:\n        \tawait this.renderMedium(widget, 9);\n        \tbreak;\n      }\n    }catch(e){\n      this.ERROR.push({error:e.toString()});\n    }\n    return widget;\n  }\n  \n  \/\/ 小组件\n  async renderSmall(w){\n    this.addText(w, '🦠 每日疫情', 13);\n    w.addSpacer()\n    const data = this.settings.coviddata;\n    for(let i = 9; i > 6; i--){\n      const text = w.addStack()\n      this.addText(text, `${data.covid[i].city}：`, 12);\n      this.addText(text, `+${data.covid[i].confirm}`, 12, {color:'FF3030'});\n      this.addText(w, `确诊：${data.covid[i].nowConfirm}`, 12, {opacity:0.8});\n      w.addSpacer(4)\n    };\n    this.addText(w, `今日新增：${data.total}`, 11, {opacity:0.8});\n  }\n  \n  \/\/ 中组件\n  async renderMedium(w, num = 3){\n    const body = w.addStack();\n    body.layoutVertically();\n    \n    const topBody = body.addStack()\n    const widgetWidth = this.getWidgetWidthSize('medium')-14\n    topBody.size = new Size(widgetWidth, 45);\n    topBody.addImage(this.makeChart())\n    body.addSpacer(3)\n    const botRow = body.addStack();\n    botRow.layoutVertically();\n    let idex = {url:'', from:'', time:''};\n    const flag = !!this.settings.city;\n    if(!flag){\n      idex.title = 'eventDescription';\n      idex.url = 'eventUrl';\n      idex.from = 'siteName';\n      idex.time = 'eventTime';\n    }else {\n      idex.title = 'title';\n      idex.url = 'news_url';\n      idex.from = 'srcfrom';\n      idex.time = 'publish_time';\n    }\n    const data = await this.covidNews();\n    for(let i = 0; i < num; i++){\n      const list = botRow.addStack()\n      list.size = new Size(widgetWidth, 26)\n      list.addSpacer(4)\n      const _list = list.addStack();\n      _list.layoutVertically();\n      this.addText(_list, data[i][idex.title], 12);\n      const time = flag ? data[i][idex.time] : this.dateFormat('yyyy-MM-dd hh:mm:ss', new Date(parseInt(data[i][idex.time])*1000));\n      this.addText(_list, `${data[i][idex.from]}  ${time}`, 9, {opacity:0.7});\n      list.url = data[i][idex.url];\n      list.addSpacer()\n      if(i+1 != num) botRow.addSpacer(3)\n    }\n  }\n  \n  makeChart(){\n    const chartCanvas = this.makeCanvas(348, 45);\n    const covidData = this.settings.coviddata;\n    const maxh = covidData.covid[9].confirm > 10\n      ? covidData.covid[9].confirm : 30;\n    const diff = maxh\/(40 - 19);\n    let idx = 0;\n    for(let key of covidData.covid){\n      const charth = key.confirm > 0 ? key.confirm\/diff : 0.7\/diff;\n      const x = (idx * 10) + (idx * 15) + 5;\n      const y = 43 - 24\/2 - charth;\n      this.fillRect(chartCanvas, x, y, 14, charth, 3, new Color('FFC125'));\n      this.drawText(chartCanvas, x-3.5, 33, 22, 10, key.city, 'regular', 9, 'center', this.widgetColor);\n      this.drawText(chartCanvas, x-10, y-12, 34, 10, key.confirm.toString(), 'regular', 8, 'center', this.widgetColor);\n      idx ++;\n    }\n    this.drawText(chartCanvas, 250, 0, 100, 15, '今日疫情新增', 'regular', 14, 'center', this.widgetColor);\n    this.drawText(chartCanvas, 261, 19, 80, 25, '+'+covidData.total, 'bold', 21, 'center', new Color('FF3030'));\n    return chartCanvas.getImage();\n  }\n  \n  \/\/ 获取疫情数据\n  async covidData(){\n    let KEY = this.SETTING_KEY+this.widget_ID;\n    const flag = !this.settings.coviddata;\n    if(this.isUpdate(KEY,0.5,true) || flag){\n      let json = {total:0,covid:[]};\n      let coviddata = await this.httpGet(this.covidUrl);\n      let data = coviddata.data.diseaseh5Shelf.areaTree[0];\n      let arr = [];\n      for(let key of data.children.splice(0, 10)){\n        let children = {confirm:0, city:'--', nowConfirm:0};\n        children.confirm = key.today.confirm;\n        children.city = key.name;\n        children.nowConfirm = key.total.nowConfirm;\n        arr.push(children)\n      }\n      arr.sort(function(a,b){return a.confirm - b.confirm})\n      json.total = data.today.confirm;\n      json.covid = arr;\n      this.settings.coviddata = json;\n      this.saveSettings(false);\n    }\n  }\n  \n  \/\/ 疫情资讯\n  async covidNews(){\n    if(!this.settings.city){\n      let covidNewsURL = \"https:\/\/opendata.baidu.com\/data\/inner?tn=reserved_all_res_tn&dspName=iphone&from_sf=1&dsp=iphone&resource_id=28565&alr=1&query=%E5%9B%BD%E5%86%85%E6%96%B0%E5%9E%8B%E8%82%BA%E7%82%8E%E6%9C%80%E6%96%B0%E5%8A%A8%E6%80%81\";\n      let data = (await this.httpGet2(covidNewsURL)).Result[0].items_v2[0].aladdin_res.DisplayData.result.items;\n      return data;\n    } else {\n      if(this.city.indexOf(this.settings.city) != -1){\n      \tlet cityID = this.cityCode[this.city.indexOf(this.settings.city)];\n      \tif(cityID){\n          let covidNewsURL = `https:\/\/api.dreamreader.qq.com\/news\/v1\/province\/news\/list?province_code=${cityID}&page_size=10`;\n          let covidNews = await this.httpGet(covidNewsURL);\n          return covidNews.data.items\n        }\n      }else {logError(\"Error：疫情资讯地区设置错误！\")};\n    }\n  }\n  \n  async httpGet2 (url, json = true, useCache = true, options = null, method = 'GET') {\n    let cacheKey = this.hash('channel.chinanews.com');\n    let cacheData = null, error = null;\n    if (this.isUpdate(cacheKey.slice(-8), useCache) || !Keychain.contains(cacheKey)){\n      try {\n        let req = new Request(url)\n        req.method = method\n        if(options){\n          Object.keys(options).forEach((key) => {\n            req[key] = options[key];\n          });\n        }\n        cacheData = await (json ? req.loadJSON() : req.loadString());\n      } catch (e) {\n        error = {url:url, error:e.toString()};\n        this.writeError(error);\n      };\n    }\n    if(cacheData && useCache) {\n      this.saveCacheKey(cacheKey);\n      Keychain.set(cacheKey, json ? JSON.stringify(cacheData) : cacheData)\n    }else if (!cacheData && Keychain.contains(cacheKey)) {\n      let cache = Keychain.get(cacheKey)\n      cacheData = json ? JSON.parse(cache) : cache\n    }else {this.ERROR.push(error);}\n    return cacheData;\n  }\n  \n  \/\/ 添加设置信息\n  Run(filename, args) {\n    if (config.runsInApp) {\n      this.registerAction(\"基础设置\", this.setWidgetConfig);\n      this.registerAction(\"地区设置\", async () => {\n        await this.setCustomAction(\"地区设置\", \"设置地区疫情最新资讯\\n港澳台地区不支持\\n正确输入省份地区\\n例如：广东\", {\n          city: \"港澳台地区不支持\",\n        },this.city);\n      }, { name: 'location.circle', color: '#66CD00' });\n    }\n  }\n}\n\/\/ @组件代码结束\nawait Runing(Widget)\n\n",
  "share_sheet_inputs" : [

  ]
}
